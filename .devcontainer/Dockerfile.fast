# Fast Build Dockerfile for Spiral Core Development
# Optimized for minimal build time - tools installed on first use

FROM mcr.microsoft.com/devcontainers/rust:1-1-bullseye

# Install GitHub CLI with verification (required for development)
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg -o /tmp/gh-keyring.gpg \
    && gpg --no-default-keyring --keyring /tmp/test-keyring.gpg --import /tmp/gh-keyring.gpg \
    && dd if=/tmp/gh-keyring.gpg of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && rm -f /tmp/gh-keyring.gpg /tmp/test-keyring.gpg

# Install system dependencies (lightweight packages only)
RUN apt-get update && apt-get install -y \
    curl wget jq tree vim nano git-extras \
    && rm -rf /var/lib/apt/lists/*

# Set up minimal Rust toolchain
RUN rustup component add clippy rustfmt rust-src \
    && rustup target add wasm32-unknown-unknown

# Switch to vscode user early
USER vscode

# Create workspace directory
WORKDIR /workspaces/spiral-core

# Set environment variables for development
ENV RUST_LOG=debug
ENV RUST_BACKTRACE=1
ENV PATH="/home/vscode/.cargo/bin:/home/vscode/.local/bin:$PATH"

# Install Claude Code CLI as vscode user (lightweight)
RUN curl -fsSL https://claude.ai/install.sh -o /tmp/claude-install.sh \
    && chmod +x /tmp/claude-install.sh \
    && /tmp/claude-install.sh \
    && rm -f /tmp/claude-install.sh \
    && echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc \
    && echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc

# Copy and source aliases file
COPY aliases.sh /tmp/aliases.sh
RUN echo '' >> ~/.bashrc \
    && echo '# Spiral Core Development Aliases' >> ~/.bashrc \
    && echo 'source /tmp/aliases.sh' >> ~/.bashrc \
    && echo '' >> ~/.zshrc \
    && echo '# Spiral Core Development Aliases' >> ~/.zshrc \
    && echo 'source /tmp/aliases.sh' >> ~/.zshrc

# Note: Heavy tools (Hurl, cargo-watch, etc.) installed via postCreateCommand
# This saves 10+ minutes of build time per build